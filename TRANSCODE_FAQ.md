# 关于"边转码边播放"的解释

## 问题陈述

用户反馈：
1. **第一次播放**：看起来像"边转码边播放"
2. **重复播放**：关闭后重新打开同一个视频，还是"边转码边播放"

## 实际情况分析

### 问题1：第一次播放看起来"边转码边播放"

**原因**：正常的转码流程，看起来像是边转码边播放

**实际流程**：
```
时间轴:
0ms    → [前端] 用户点击播放
100ms  → [前端] 检测到需要转码，显示 "视频转码中..." 动画
100ms  → [前端] 调用 IPC 发起转码请求
        → [主进程] 发送 HTTP 请求到转码服务
        → [转码服务] 下载视频（可能 10-30 秒）
        → [转码服务] 运行 ffmpeg（可能 10-30 秒）
        → [转码服务] 返回缓存ID
        ← [主进程] 收到响应
        ← [前端] 收到缓存ID
5000ms → [前端] 隐藏"视频转码中..."动画
5000ms → [前端] 设置 video src 为文件URL
5000ms → [视频] 浏览器加载视频元数据
7000ms → [视频] canplay 事件触发，开始播放
```

**看起来"边转码边播放"的原因**：
- 在转码进行中，转码动画确实在显示
- 用户可能误认为视频已经在播放

**正确的体验**：
- 应该看到 "视频转码中..." 的加载动画一直显示，直到转码完全完成

### 问题2：重复播放时还是"边转码边播放"

**原因**：缓存检查失败 或 URL 不匹配

**可能原因**：

1. **URL 不完全匹配**
   - 第一次: `https://example.com/video.mov`
   - 第二次: `https://example.com/video.mov?timestamp=123` （带查询参数）
   - 这两个被当作不同的视频，需要重新转码

2. **缓存被清理**
   - 手动删除了 `%TEMP%/transcode-cache/`
   - 或系统自动清理临时文件

3. **缓存文件损坏**
   - 转码中途出错，文件不完整（< 1KB）
   - `hasCached()` 会验证文件大小

4. **URL 编码问题**
   - 特殊字符在编码中不一致
   - MD5 哈希不同

## 验证方法

### 方法1：查看日志（推荐）

开发工具（DevTools）→ Console 标签：

#### 首次转码应该看到：
```
[ipc] 🎬 开始处理转码请求
[ipc] 转码服务端口: 20828
[transcode-server] ⏳ 新转码请求: https://...
[transcode-server] ⚙️  缓存未命中，开始转码...
[transcode-server] 📥 下载到临时文件: ...
[transcode-server] ✅ ffmpeg 转码成功! 耗时: 15234ms
[ipc] 📥 收到转码服务响应，耗时: 15345 ms
[video] 转码完成，耗时: 15345ms
```

#### 重复播放应该看到：
```
[ipc] 🎬 开始处理转码请求
[ipc] 转码服务端口: 20828
[transcode-server] ⏳ 新转码请求: https://...
[transcode-server] ✅ 缓存命中! 缓存ID: transcode-04e341ec800839ee82...
[ipc] 📥 收到转码服务响应，耗时: 1 ms          ← 注意：耗时 < 10 ms
[ipc] ✅ 转码完成! 返回缓存ID: transcode-04e341ec800839ee8...
[video] 转码完成，耗时: 1ms                    ← 注意：耗时 < 10 ms
```

### 方法2：检查缓存目录

打开：`C:\Users\{用户名}\AppData\Local\Temp\transcode-cache\`

- **第一次转码后**：应该有 1 个 MP4 文件
- **重复播放**：如果耗时 < 10ms，说明命中了缓存
- **多个视频**：应该有多个 transcode-*.mp4 文件（最多5个）

### 方法3：检查文件修改时间

缓存命中时，文件的修改时间（Modified）不变

缓存未命中时，会生成新文件（修改时间为当前）

## 现在应该正常的行为

### ✅ 首次播放 H.265 视频
- 显示 "视频转码中..." 加载动画
- 等待转码完成（可能 10-60 秒）
- 转码完成后隐藏动画
- 播放转码后的 H.264 视频

### ✅ 重复播放同一个视频
- 显示 "视频转码中..." 加载动画（极短时间）
- 立即返回缓存（< 10ms）
- 隐藏动画
- 播放缓存的视频文件

### ✅ 播放不同的 H.265 视频
- 与首次播放相同（新的转码）

## 改进说明

我们已经修复的问题：

| 问题 | 原状态 | 现状态 |
|------|--------|--------|
| 缓存加载 | 程序启动时丢失 | ✅ 自动加载已有缓存 |
| 缓存检查 | 基础检查 | ✅ 增强检查（文件大小验证） |
| 日志详度 | 简洁 | ✅ 详细的中文日志（显示进度） |
| 用户反馈 | 无 | ✅ 加载动画 + 日志 |
| 播放等待 | 可能立即播放 | ✅ 等待 canplay 事件 + 5s 超时 |

## 如果问题依然存在

请在 DevTools Console 中查看日志，并告诉我：

1. 重复播放时，`[ipc] 📥 收到转码服务响应，耗时: ? ms` 显示的是多少？
2. 是否显示 `[transcode-server] ✅ 缓存命中!` ？
3. 缓存目录中有多少个文件？

这些信息将帮助定位真实原因。
