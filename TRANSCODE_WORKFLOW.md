# 转码功能工作流程说明

## 核心概念

本应用的转码功能采用 **请求-响应-缓存** 模式：

```
┌─────────────────────────────────────────────────────────────┐
│                     前端（Vue组件）                          │
│  用户点击播放 → 检测是否需转码 → 等待 IPC 响应 → 播放     │
└─────────┬─────────────────────────────────────────────────────┘
          │
          │ IPC 调用 get-transcode-url(inputUrl)
          │
┌─────────▼─────────────────────────────────────────────────────┐
│                   主进程（IPC 处理）                          │
│  获取转码端口 → 调用 HTTP /transcode?url=... → 等待响应     │
└─────────┬─────────────────────────────────────────────────────┘
          │
          │ HTTP 请求
          │
┌─────────▼─────────────────────────────────────────────────────┐
│              转码服务器（Node HTTP）                          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 1. 检查缓存（MD5 Hash）                               │ │
│  │    ✅ 缓存命中 → 直接返回缓存ID                        │ │
│  │    ❌ 缓存未命中 → 继续                               │ │
│  │                                                        │ │
│  │ 2. 下载视频到临时文件                                │ │
│  │    使用 Electron net 模块（带浏览器标识）             │ │
│  │                                                        │ │
│  │ 3. 运行 ffmpeg 转码                                   │ │
│  │    H.265 → H.264 MP4 格式                            │ │
│  │    🎥 等待 ffmpeg 完全完成                             │ │
│  │                                                        │ │
│  │ 4. 清理临时文件                                       │ │
│  │    删除下载的临时文件                                  │ │
│  │                                                        │ │
│  │ 5. 保存到缓存                                         │ │
│  │    位置: %TEMP%/transcode-cache/transcode-{MD5}.mp4  │ │
│  │    LRU: 最多保留 5 个文件                            │ │
│  │                                                        │ │
│  │ 6. 返回缓存ID                                         │ │
│  │    {success: true, cacheId: "transcode-abc123.mp4"}  │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────┬─────────────────────────────────────────────────────┘
          │
          │ 返回 HTTP 响应
          │
┌─────────▼─────────────────────────────────────────────────────┐
│                  主进程（IPC 响应）                          │
│  解析缓存ID → 返回给前端                                    │
└─────────┬─────────────────────────────────────────────────────┘
          │
          │ IPC 返回 {success, cacheId}
          │
┌─────────▼─────────────────────────────────────────────────────┐
│                     前端（播放）                              │
│  构造文件URL → 设置到video标签src → 等待canplay → 播放     │
│  URL: http://127.0.0.1:PORT/file?id=transcode-abc123.mp4    │
└─────────┬─────────────────────────────────────────────────────┘
          │
          │ HTTP 请求（加载视频文件）
          │
┌─────────▼─────────────────────────────────────────────────────┐
│              转码服务器（文件提供）                          │
│  验证缓存ID → 读取文件 → 流式传输 MP4 给浏览器            │
└─────────────────────────────────────────────────────────────────┘
```

## 关键特性

### ✅ 缓存持久化
- 程序启动时自动加载已有的缓存文件
- 即使重启应用，之前的转码结果仍然可用
- 缓存位置：`C:\Users\...\AppData\Local\Temp\transcode-cache\`

### ✅ 缓存命中快速响应
- 第一次转码：需要下载 + 转码（可能需要数秒至数十秒）
- 重复播放同URL：直接返回缓存ID（< 1ms）

### ✅ 安全的资源隐藏
- 不暴露本地文件路径
- 通过缓存ID（相对名称）访问文件
- 防止路径遍历攻击

### ✅ 智能缓存管理
- 最多保留5个缓存文件（LRU策略）
- 超限时自动删除最旧文件
- 临时下载文件在转码后立即删除

### ✅ 完整的等待机制
1. 前端 `isTranscoding = true`，显示加载动画
2. IPC 阻塞等待 HTTP 响应完成
3. HTTP 服务器阻塞等待 ffmpeg 进程完成
4. ffmpeg 完全完成后，返回缓存ID
5. 前端接收后设置视频源并播放

## 日志解读

### 首次转码（缓存未命中）

```
[ipc] 🎬 开始处理转码请求
[ipc] 转码服务端口: 20828 视频URL: https://...
[ipc] 📡 调用转码服务: http://127.0.0.1:20828/transcode?url=...
[ipc] 📤 发送转码请求...

[transcode-server] ⏳ 新转码请求: https://...
[transcode-server] ⚙️  缓存未命中，开始转码...
[transcode-server] 📥 下载到临时文件: C:\Users\...\Temp\transcode-download-1731509400000.tmp
[transcode-server] ✅ 下载完成，开始 ffmpeg 转码...
[transcode-server] 转码开始: 输入文件: ... 输出文件: ...
[ffmpeg] frame=123 fps=456 speed=1.2x ...   # 转码进度（实时更新）
[transcode-server] ✅ ffmpeg 转码成功! 耗时: 15234ms, 输出文件大小: 7564010 bytes
[transcode-server] ✅ 转码完成!
[transcode-server] 📤 返回缓存ID: transcode-04e341ec800839ee8230659e6553364c.mp4
[ipc] 📥 收到转码服务响应，耗时: 15345 ms, 状态码: 200
[ipc] ✅ 转码完成! 返回缓存ID: transcode-04e341ec800839ee8230659e6553364c.mp4

[video] 转码完成，耗时: 15345ms，获取到缓存ID: ...
[video] 设置播放URL: http://127.0.0.1:20828/file?id=transcode-04e341ec800839ee8230659e6553364c.mp4
[video] 调用videoElement.load()
[video] 已设置播放源，等待 canplay 事件...
[video] 视频可以播放，开始播放
```

### 缓存命中（重复播放同URL）

```
[ipc] 🎬 开始处理转码请求
[ipc] 转码服务端口: 20828 视频URL: https://...
[ipc] 📡 调用转码服务: http://127.0.0.1:20828/transcode?url=...
[ipc] 📤 发送转码请求...

[transcode-server] ⏳ 新转码请求: https://...
[transcode-server] ✅ 缓存命中! 缓存ID: transcode-04e341ec800839ee8230659e6553364c.mp4
[ipc] 📥 收到转码服务响应，耗时: 1 ms, 状态码: 200
[ipc] ✅ 转码完成! 返回缓存ID: transcode-04e341ec800839ee8230659e6553364c.mp4

[video] 转码完成，耗时: 1ms，获取到缓存ID: ...
[video] 设置播放URL: http://127.0.0.1:20828/file?id=transcode-04e341ec800839ee8230659e6553364c.mp4
[video] 调用videoElement.load()
[video] 已设置播放源，等待 canplay 事件...
[video] 视频可以播放，开始播放
```

## 性能指标

| 场景 | 耗时 | 说明 |
|------|------|------|
| 首次转码 | 10-60 秒 | 取决于视频大小和 CPU |
| 缓存命中 | < 10 ms | 从磁盘读取元数据 |
| 文件加载 | 1-2 秒 | 浏览器加载视频元数据 |

## 常见问题

### Q: 为什么第一次还是慢的？
A: 这是正常的。第一次需要：
- 下载完整视频（可能几十MB）
- ffmpeg 转码（CPU 密集）
- 保存文件

### Q: 为什么重复播放还是慢？
A: 可能原因：
1. 缓存被清理了（检查 `%TEMP%/transcode-cache/`）
2. URL 有变化（参数、Query String 等）
3. 浏览器重新加载视频元数据

### Q: 如何清理缓存？
A: 手动删除 `%TEMP%/transcode-cache/` 目录
（下次启动自动创建）

### Q: 缓存在哪？
A: `C:\Users\{用户名}\AppData\Local\Temp\transcode-cache\`

## 测试步骤

1. **首次转码测试**
   - 打开 H.265 视频 → 观察日志 → 应显示缓存未命中 → 转码进行中 → 完成后播放

2. **缓存命中测试**
   - 关闭视频
   - 重新打开同一视频 → 观察日志 → 应显示缓存命中 → 立即返回 < 10ms

3. **多文件测试**
   - 打开 6 个不同的 H.265 视频
   - 观察缓存目录 → 应自动删除最旧的，保留最新的 5 个

4. **缓存清理测试**
   - 手动删除 `%TEMP%/transcode-cache/`
   - 重启应用 → 重新打开视频 → 应重新转码
